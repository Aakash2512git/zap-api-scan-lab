name: Manual OWASP ZAP Scan for OpenShift Route

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: "OpenShift route URL to scan (example: https://myapp.apps.cluster.example.com/api/query)"
        required: true
        type: string

jobs:
  zap-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Show target
        run: |
          echo "üîç Scanning target:"
          echo "${{ inputs.target_url }}"

      - name: Validate URL
        run: |
          echo "${{ inputs.target_url }}" | grep -E '^https?://' || exit 1

      - name: Run OWASP ZAP scan
        uses: zaproxy/action-baseline@v0.10.0
        continue-on-error: true
        with:
          target: ${{ inputs.target_url }}
          artifact_name: zap-report

      - name: Show vulnerability summary (Low / Medium / High)
        run: |
          echo "üìä Vulnerability Summary"
          echo "------------------------"

          REPORT=/zap/wrk/zap_report.json

          echo "üî¥ High:"
          jq '[.site[].alerts[] | select(.riskdesc | startswith("High"))] | length' $REPORT

          echo "üü† Medium:"
          jq '[.site[].alerts[] | select(.riskdesc | startswith("Medium"))] | length' $REPORT

          echo "üü° Low:"
          jq '[.site[].alerts[] | select(.riskdesc | startswith("Low"))] | length' $REPORT

      - name: Upload ZAP reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            /zap/wrk/zap_report.html
            /zap/wrk/zap_report.json
