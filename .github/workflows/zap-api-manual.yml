name: Manual OWASP ZAP Scan (Severity Summary)

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: "OpenShift route URL (example: https://myapp.apps.cluster.example.com/api/query)"
        required: true
        type: string

jobs:
  zap-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Show target
        run: |
          echo "ðŸ” Scanning target:"
          echo "${{ inputs.target_url }}"

      - name: Validate URL
        run: |
          echo "${{ inputs.target_url }}" | grep -E '^https?://' || exit 1

      - name: Run OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.10.0
        continue-on-error: true
        with:
          target: ${{ inputs.target_url }}
          cmd_options: >
            -I

      - name: Generate vulnerability summary file
        shell: bash
        run: |
          REPORT="/zap/wrk/report_json.json"
          OUTPUT="zap-vulnerability-summary.txt"

          if [ ! -f "$REPORT" ]; then
            echo "âŒ ZAP report not found at $REPORT"
            echo "ðŸ“‚ Contents of /zap/wrk:"
            ls -la /zap/wrk
            exit 1
          fi

          {
            echo "OWASP ZAP Vulnerability Report"
            echo "Target: ${{ inputs.target_url }}"
            echo "Generated on: $(date)"
            echo "==================================="
            echo
            echo "ðŸ”´ HIGH SEVERITY"
            jq -r '.site[].alerts[]?
              | select(.riskdesc | startswith("High"))
              | "- \(.alert)\n  URL: \(.instances[0].uri)\n"' "$REPORT" || true

            echo
            echo "ðŸŸ  MEDIUM SEVERITY"
            jq -r '.site[].alerts[]?
              | select(.riskdesc | startswith("Medium"))
              | "- \(.alert)\n  URL: \(.instances[0].uri)\n"' "$REPORT" || true

            echo
            echo "ðŸŸ¡ LOW SEVERITY"
            jq -r '.site[].alerts[]?
              | select(.riskdesc | startswith("Low"))
              | "- \(.alert)\n  URL: \(.instances[0].uri)\n"' "$REPORT" || true
          } > "$OUTPUT"

          echo "âœ… Summary written to $OUTPUT"
          echo "-----------------------------------"
          cat "$OUTPUT"

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            zap-vulnerability-summary.txt
            /zap/wrk/report_html.html
            /zap/wrk/report_json.json
