name: Manual OWASP ZAP Scan for OpenShift Route

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: "OpenShift route URL to scan (example: https://myapp.apps.cluster.example.com/api/query)"
        required: true
        type: string

jobs:
  zap-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Show target
        run: |
          echo "ðŸ” Scanning target:"
          echo "${{ inputs.target_url }}"

      - name: Validate URL
        run: |
          echo "${{ inputs.target_url }}" | grep -E '^https?://' || exit 1

      - name: Run OWASP ZAP scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: ${{ inputs.target_url }}
          fail_action: false
          artifact_name: zap-report
          cmd_options: >
            -J zap-report.json
            -r zap-report.html

      - name: Show vulnerability summary (Low / Medium / High)
        run: |
          echo "ðŸ“Š Vulnerability Summary"
          echo "------------------------"

          echo "ðŸ”´ High:"
          jq '[.site[].alerts[] | select(.riskdesc | startswith("High"))] | length' zap-report.json

          echo "ðŸŸ  Medium:"
          jq '[.site[].alerts[] | select(.riskdesc | startswith("Medium"))] | length' zap-report.json

          echo "ðŸŸ¡ Low:"
          jq '[.site[].alerts[] | select(.riskdesc | startswith("Low"))] | length' zap-report.json

      - name: Upload ZAP reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            zap-report.html
            zap-report.json
